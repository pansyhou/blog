"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[8533],{4137:function(e,n,t){t.d(n,{Zo:function(){return s},kt:function(){return u}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),c=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},s=function(e){var n=c(e.components);return a.createElement(p.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),m=c(t),u=r,k=m["".concat(p,".").concat(u)]||m[u]||d[u]||i;return t?a.createElement(k,l(l({ref:n},s),{},{components:t})):a.createElement(k,l({ref:n},s))}));function u(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=m;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=t[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},4740:function(e,n,t){t.r(n),t.d(n,{assets:function(){return s},contentTitle:function(){return p},default:function(){return u},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return d}});var a=t(3117),r=t(102),i=(t(7294),t(4137)),l=["components"],o={id:"arm-driver-dev1",slug:"/arm-driver-dev1",title:"ARM-Linux\u9a71\u52a8\u5f00\u53d11",authors:"pansyhou"},p=void 0,c={unversionedId:"skill/Linux/arm-driver-dev1",id:"skill/Linux/arm-driver-dev1",title:"ARM-Linux\u9a71\u52a8\u5f00\u53d11",description:"\u4eca\u5929\u7ec8\u4e8e\u4e0a\u624b\u677f\u5b50\u4e86\u3002\u7528uboot \u7684tftp\u628adtb\u548czImage\u4e0b\u8f7d\u4e4b\u540ebootz\u53d1\u73b0\u56e0\u4e3avfs kernel panic\u4e86",source:"@site/docs/skill/Linux/ARMLinux\u9a71\u52a8\u5f00\u53d11.md",sourceDirName:"skill/Linux",slug:"/arm-driver-dev1",permalink:"/docs/arm-driver-dev1",draft:!1,tags:[],version:"current",frontMatter:{id:"arm-driver-dev1",slug:"/arm-driver-dev1",title:"ARM-Linux\u9a71\u52a8\u5f00\u53d11",authors:"pansyhou"},sidebar:"skill",previous:{title:"I.MX6U\u5b66\u4e60\u7b14\u8bb0\u7cfb\u7edf\u79fb\u690d\u7bc72",permalink:"/docs/zdyzlinuxsys2"},next:{title:"ARM-Linux\u9a71\u52a8\u5f00\u53d12",permalink:"/docs/arm-driver-dev2"}},s={},d=[{value:"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1",id:"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1",level:2},{value:"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u6a21\u677f",id:"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u6a21\u677f",level:3},{value:"\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c",id:"\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c",level:4},{value:"Linux\u8bbe\u5907\u53f7",id:"linux\u8bbe\u5907\u53f7",level:3},{value:"\u52a8\u6001\u5206\u914d\u8bbe\u5907\u53f7",id:"\u52a8\u6001\u5206\u914d\u8bbe\u5907\u53f7",level:4},{value:"LED\u9a71\u52a8",id:"led\u9a71\u52a8",level:3},{value:"ioremap\u5b8f",id:"ioremap\u5b8f",level:4},{value:"iounmap \u5b8f",id:"iounmap-\u5b8f",level:4},{value:"IO\u5185\u5b58\u8bbf\u95ee\u51fd\u6570",id:"io\u5185\u5b58\u8bbf\u95ee\u51fd\u6570",level:4},{value:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u53f7",id:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u53f7",level:4},{value:"\u65b0\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c\u65b9\u6cd5",id:"\u65b0\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c\u65b9\u6cd5",level:4},{value:"\u521b\u5efa\u8bbe\u5907\u8282\u70b9",id:"\u521b\u5efa\u8bbe\u5907\u8282\u70b9",level:4},{value:"\u8bbe\u5907\u6811",id:"\u8bbe\u5907\u6811",level:2},{value:"Basic concept",id:"basic-concept",level:3},{value:"<strong>Linux\u5185\u6838\u89e3\u6790DTB\u6587\u4ef6</strong>",id:"linux\u5185\u6838\u89e3\u6790dtb\u6587\u4ef6",level:4},{value:"\u7ed1\u5b9a\u4fe1\u606f\u6587\u6863",id:"\u7ed1\u5b9a\u4fe1\u606f\u6587\u6863",level:4},{value:"\u8bbe\u5907\u6811\u5e38\u7528  OF \u64cd\u4f5c\u51fd\u6570",id:"\u8bbe\u5907\u6811\u5e38\u7528--of-\u64cd\u4f5c\u51fd\u6570",level:4}],m={toc:d};function u(e){var n=e.components,t=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"\u4eca\u5929\u7ec8\u4e8e\u4e0a\u624b\u677f\u5b50\u4e86\u3002\u7528uboot \u7684tftp\u628adtb\u548czImage\u4e0b\u8f7d\u4e4b\u540ebootz\u53d1\u73b0\u56e0\u4e3avfs kernel panic\u4e86"),(0,i.kt)("p",null,"\u95ee\u9898\u662f\uff0cuboot\u7684bootargs\u91cc\u7684root\u53d8\u91cf\u7406\u8bba\u4e0a\u662f\u6709\u8f7d\u5165\u7684\uff0c\u7406\u8bba\u4e0a\u662froot=/dev/mmcblk1p2\uff0c\u5b58\u653e\u5728emmc\u7684"),(0,i.kt)("p",null,"\u90a3uboot\u4f20\u53c2\u5982\u679c\u6b63\u786e\u7684\u8bdd\u5c31\u4e0d\u4f1a\u542f\u52a8vfs\u5427\uff1f"),(0,i.kt)("p",null,"why?"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Starting kernel ..."),(0,i.kt)("p",{parentName:"blockquote"},"Booting Linux on physical CPU 0x0\nLinux version 4.1.15 (pansy@ubuntu) (gcc version 7.5.0 (Linaro GCC 7.5-2019.12) ) #2 SMP PREEMPT Tue Sep 5 06:56:44 PDT 2023\nCPU: ARMv7 Processor ","[410fc075]"," revision 5 (ARMv7), cr=10c5387d\nCPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache\nMachine model: Freescale i.MX6 ULL 14x14 EVK Board\nReserved memory: created CMA memory pool at 0x8c000000, size 320 MiB\nReserved memory: initialized node linux,cma, compatible id shared-dma-pool\nMemory policy: Data cache writealloc\nPERCPU: Embedded 12 pages/cpu @8bb32000 s16716 r8192 d24244 u49152\nBuilt 1 zonelists in Zone order, mobility grouping on.  Total pages: 130048\nKernel command line: noinitrd console=ttymxc0,115200\nPID hash table entries: 2048 (order: 1, 8192 bytes)\nDentry cache hash table entries: 65536 (order: 6, 262144 bytes)\nInode-cache hash table entries: 32768 (order: 5, 131072 bytes)\nMemory: 180844K/524288K available (6856K kernel code, 322K rwdata, 2360K rodata, 428K init, 424K bss, 15764K reserved, 327680K cma-reserved, 0K highmem)\nVirtual kernel memory layout:\nvector  : 0xffff0000 - 0xffff1000   (   4 kB)\nfixmap  : 0xffc00000 - 0xfff00000   (3072 kB)\nvmalloc : 0xa0800000 - 0xff000000   (1512 MB)\nlowmem  : 0x80000000 - 0xa0000000   ( 512 MB)\npkmap   : 0x7fe00000 - 0x80000000   (   2 MB)\nmodules : 0x7f000000 - 0x7fe00000   (  14 MB)\n.text : 0x80008000 - 0x80908510   (9218 kB)\n.init : 0x80909000 - 0x80974000   ( 428 kB)\n.data : 0x80974000 - 0x809c4800   ( 322 kB)\n.bss : 0x809c7000 - 0x80a31194   ( 425 kB)\nSLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1\nPreemptible hierarchical RCU implementation.\nAdditional per-CPU info printed with stalls.\nRCU restricting CPUs from NR_CPUS=4 to nr_cpu_ids=1.\nRCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1\nNR_IRQS:16 nr_irqs:16 16\nmxc_clocksource_init 3000000\nSwitching to timer-based delay loop, resolution 333ns\nsched_clock: 32 bits at 3000kHz, resolution 333ns, wraps every 715827882841ns\nclocksource mxc_timer1: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 637086815595 ns\nConsole: colour dummy device 80x30\nCalibrating delay loop (skipped), value calculated using timer frequency.. 6.00 BogoMIPS (lpj=30000)\npid_max: default: 32768 minimum: 301\nMount-cache hash table entries: 1024 (order: 0, 4096 bytes)\nMountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)\nCPU: Testing write buffer coherency: ok\n/cpus/cpu@0 missing clock-frequency property\nCPU0: thread -1, cpu 0, socket 0, mpidr 80000000\nSetting up static identity map for 0x80008280 - 0x800082d8\nBrought up 1 CPUs\nSMP: Total of 1 processors activated (6.00 BogoMIPS).\nCPU: All CPU(s) started in SVC mode.\ndevtmpfs: initialized\ndevice-tree: Duplicate name in lcdif@021c8000, renamed to \"display#1\"\nVFP support v0.3: implementor 41 architecture 2 part 30 variant 7 rev 5\nclocksource jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns\npinctrl core: initialized pinctrl subsystem\nNET: Registered protocol family 16\nDMA: preallocated 256 KiB pool for atomic coherent allocations\ncpuidle: using governor ladder\ncpuidle: using governor menu\nhw-breakpoint: found 5 (+1 reserved) breakpoint and 4 watchpoint registers.\nhw-breakpoint: maximum watchpoint size is 8 bytes.\nimx6ul-pinctrl 20e0000.iomuxc: initialized IMX pinctrl driver\nimx6ul-pinctrl 2290000.iomuxc-snvs: initialized IMX pinctrl driver\nmxs-dma 1804000.dma-apbh: initialized\nSCSI subsystem initialized\nusbcore: registered new interface driver usbfs\nusbcore: registered new interface driver hub\nusbcore: registered new device driver usb\ni2c i2c-0: IMX I2C adapter registered\ni2c i2c-0: can't use DMA\ni2c i2c-1: IMX I2C adapter registered\ni2c i2c-1: can't use DMA\nLinux video capture interface: v2.00\npps_core: LinuxPPS API ver. 1 registered\npps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti ",(0,i.kt)("a",{parentName:"p",href:"mailto:giometti@linux.it"},"giometti@linux.it"),"\nPTP clock support registered\nAdvanced Linux Sound Architecture Driver Initialized.\nSwitched to clocksource mxc_timer1\nNET: Registered protocol family 2\nTCP established hash table entries: 4096 (order: 2, 16384 bytes)\nTCP bind hash table entries: 4096 (order: 3, 32768 bytes)\nTCP: Hash tables configured (established 4096 bind 4096)\nUDP hash table entries: 256 (order: 1, 8192 bytes)\nUDP-Lite hash table entries: 256 (order: 1, 8192 bytes)\nNET: Registered protocol family 1\nRPC: Registered named UNIX socket transport module.\nRPC: Registered udp transport module.\nRPC: Registered tcp transport module.\nRPC: Registered tcp NFSv4.1 backchannel transport module.\nimx rpmsg driver is registered.\nBus freq driver module loaded\nfutex hash table entries: 256 (order: 2, 16384 bytes)\nVFS: Disk quotas dquot_6.6.0\nVFS: Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)\nNFS: Registering the id_resolver key type\nKey type id_resolver registered\nKey type id_legacy registered\njffs2: version 2.2. (NAND) \xa9 2001-2006 Red Hat, Inc.\nfuse init (API version 7.23)\nio scheduler noop registered\nio scheduler deadline registered\nio scheduler cfq registered (default)\nimx-weim 21b8000.weim: Driver registered.\nbacklight supply power not found, using dummy regulator\n21c8000.lcdif supply lcd not found, using dummy regulator\nmxsfb 21c8000.lcdif: failed to find mxc display driver\nConsole: switching to colour frame buffer device 60x34\nmxsfb 21c8000.lcdif: initialized\nimx-sdma 20ec000.sdma: no event needs to be remapped\nimx-sdma 20ec000.sdma: loaded firmware 3.3\nimx-sdma 20ec000.sdma: initialized\n2020000.serial: ttymxc0 at MMIO 0x2020000 (irq = 18, base_baud = 5000000) is a IMX\nconsole ","[ttymxc0]"," enabled\n21e8000.serial: ttymxc1 at MMIO 0x21e8000 (irq = 235, base_baud = 5000000) is a IMX\nimx sema4 driver is registered.\n","[drm]"," Initialized drm 1.1.0 20060810\n","[drm]"," Initialized vivante 1.0.0 20120216 on minor 0\nbrd: module loaded\nloop: module loaded\nfsl-quadspi 21e0000.qspi: unrecognized JEDEC id bytes: ff, ff, ff\nfsl-quadspi 21e0000.qspi: Freescale QuadSPI probe failed\n20b4000.ethernet supply phy not found, using dummy regulator\npps pps0: new PPS source ptp0\nlibphy: fec_enet_mii_bus: probed\nfec 20b4000.ethernet eth0: registered PHC device 0\n2188000.ethernet supply phy not found, using dummy regulator\npps pps1: new PPS source ptp1\nfec 2188000.ethernet eth1: registered PHC device 1\nehci_hcd: USB 2.0 'Enhanced' Host Controller (EHCI) Driver\nehci-mxc: Freescale On-Chip EHCI Host driver\nusbcore: registered new interface driver usb-storage\n2184800.usbmisc supply vbus-wakeup not found, using dummy regulator\n2184000.usb supply vbus not found, using dummy regulator\n2184200.usb supply vbus not found, using dummy regulator\nci_hdrc ci_hdrc.1: EHCI Host Controller\nci_hdrc ci_hdrc.1: new USB bus registered, assigned bus number 1\nci_hdrc ci_hdrc.1: USB 2.0 started, EHCI 1.00\nhub 1-0:1.0: USB hub found\nhub 1-0:1.0: 1 port detected\nMass Storage Function, version: 2009/09/11\nLUN: removable file: (no medium)\nno file given for LUN0\ng_mass_storage ci_hdrc.0: failed to start g_mass_storage: -22\nmousedev: PS/2 mouse device common for all mice\ninput: 20cc000.snvs:snvs-powerkey as /devices/platform/soc/2000000.aips-bus/20cc000.snvs/20cc000.snvs:snvs-powerkey/input/input0\ninput: iMX6UL TouchScreen Controller as /devices/platform/soc/2000000.aips-bus/2040000.tsc/input/input1\nsnvs_rtc 20cc000.snvs:snvs-rtc-lp: rtc core: registered 20cc000.snvs:snvs-r as rtc0\ni2c /dev entries driver\nIR NEC protocol handler initialized\nIR RC5(x/sz) protocol handler initialized\nIR RC6 protocol handler initialized\nIR JVC protocol handler initialized\nIR Sony protocol handler initialized\nIR SANYO protocol handler initialized\nIR Sharp protocol handler initialized\nIR MCE Keyboard/mouse protocol handler initialized\nIR XMP protocol handler initialized\npxp-v4l2 pxp_v4l2: initialized\nimx2-wdt 20bc000.wdog: use WDOG_B to reboot.\nimx2-wdt 20bc000.wdog: timeout 60 sec (nowayout=0)\nsdhci: Secure Digital Host Controller Interface driver\nsdhci: Copyright(c) Pierre Ossman\nsdhci-pltfm: SDHCI platform and OF driver helper\n/soc/aips-bus@02100000/usdhc@02190000: voltage-ranges unspecified\nsdhci-esdhc-imx 2190000.usdhc: Got CD GPIO\nsdhci-esdhc-imx 2190000.usdhc: No vqmmc regulator found\nmmc0: SDHCI controller on 2190000.usdhc ","[2190000.usdhc]"," using ADMA\n/soc/aips-bus@02100000/usdhc@02194000: voltage-ranges unspecified\nsdhci-esdhc-imx 2194000.usdhc: No vmmc regulator found\nsdhci-esdhc-imx 2194000.usdhc: No vqmmc regulator found\nmmc1: SDHCI controller on 2194000.usdhc ","[2194000.usdhc]",' using ADMA\nusbcore: registered new interface driver usbhid\nusbhid: USB HID core driver\nusb 1-1: new high-speed USB device number 2 using ci_hdrc\nNET: Registered protocol family 10\nsit: IPv6 over IPv4 tunneling driver\nNET: Registered protocol family 17\nKey type dns_resolver registered\nmmc1: MAN_BKOPS_EN bit is not set\nRegistering SWP/SWPB emulation handler\nsnvs_rtc 20cc000.snvs:snvs-rtc-lp: setting system clock to 2021-07-21 09:13:32 UTC (1626858812)\nmmc1: new DDR MMC card at address 0001\nmmcblk1: mmc1:0001 8GTF4R 7.28 GiB\nmmcblk1boot0: mmc1:0001 8GTF4R partition 1 4.00 MiB\nVSD_3V3: disabling\ncan-3v3: disabling\nALSA device list:\nNo soundcards found.\nmmcblk1boot1: mmc1:0001 8GTF4R partition 2 4.00 MiB\nmmcblk1rpmb: mmc1:0001 8GTF4R partition 3 512 KiB\nmmcblk1: p1 p2\nVFS: Cannot open root device "(null)" or unknown-block(0,0): error -6\nPlease append a correct "root=" boot option; here are the available partitions:\n0100           65536 ram0  (driver?)\n0101           65536 ram1  (driver?)\n0102           65536 ram2  (driver?)\n0103           65536 ram3\nhub 1-1:1.0: USB hub found\n(driver?)\nhub 1-1:1.0: 4 ports detected\n0104           65536 ram4  (driver?)\n0105           65536 ram5  (driver?)\n0106           65536 ram6  (driver?)\n0107           65536 ram7  (driver?)\n0108           65536 ram8  (driver?)\n0109           65536 ram9  (driver?)\n010a           65536 ram10  (driver?)\n010b           65536 ram11  (driver?)\n010c           65536 ram12  (driver?)\n010d           65536 ram13  (driver?)\n010e           65536 ram14  (driver?)\n010f           65536 ram15  (driver?)\nb300         7634944 mmcblk1  driver: mmcblk\nb301          131072 mmcblk1p1 685721ca-01\nb302         7493632 mmcblk1p2 685721ca-02\nb330             512 mmcblk1rpmb  (driver?)\nb320            4096 mmcblk1boot1  (driver?)\nb310            4096 mmcblk1boot0  (driver?)\nKernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)\n---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)\nrandom: nonblocking pool is initialized')),(0,i.kt)("p",null,"\u6ca1\u67e5\u51fa\u95ee\u9898\uff0c\u53ef\u80fd\u5148\u4ece\u79fb\u690duboot\u5165\u624b"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u70e7\u5199"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"chmod 777 imxdownload\n./imxdownload uboot.bin /dev/sdd\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"SD \u5361\u548c  EMMC \u9a71\u52a8\u68c0\u67e5"),(0,i.kt)("p",{parentName:"li"},"mmc list\u5217\u51fammc\u8bbe\u5907\nmmc dev 0\uff0cmmc info"))),(0,i.kt)("h2",{id:"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1"},"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1"),(0,i.kt)("p",null,"\u901a\u8fc7\u5b9e\u73b0open\u3001read\u3001write\u7b49\u7b49\u7684\u51fd\u6570\uff0c\u5b8c\u6210include/linux/fs.h \u4e2d file_operations \u7684\u7ed3\u6784\u4f53( \u5185\u5c0f\u6838\u9a71\u52a8\u64cd\u4f5c\u51fd\u6570\u96c6\u5408)\u3001\u9a71\u52a8\u6a21\u5757\u52a0\u8f7d"),(0,i.kt)("h3",{id:"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u6a21\u677f"},"\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8\u6a21\u677f"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},' /* \u9a71\u52a8\u5165\u53e3\u51fd\u6570    */\n static int __init xxx_init(void)\n{\n     /* \u5165\u53e3\u51fd\u6570\u5177\u4f53\u5185\u5bb9    */\n     return 0;\n}\n\n /* \u9a71\u52a8\u51fa\u53e3\u51fd\u6570    */\n static void __exit xxx_exit(void)\n{\n    /* \u51fa\u53e3\u51fd\u6570\u5177\u4f53\u5185\u5bb9    */\n}\n\n /* \u5c06\u4e0a\u9762\u4e24\u4e2a\u51fd\u6570\u6307\u5b9a\u4e3a\u9a71\u52a8\u7684\u5165\u53e3\u548c\u51fa\u53e3\u51fd\u6570   */\n module_init(xxx_init);\n module_exit(xxx_exit);\n//\u6dfb\u52a0license\n MODULE_LICENSE("GPL");\n MODULE_AUTHOR("zuozhongkai");\n')),(0,i.kt)("p",null,"\u9a71\u52a8\u7f16\u8bd1\u5b8c\u6210\u540e\u62d3\u5c55\u540d\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},".ko"),"\uff0c\u9700\u8981\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"insmod")," \u548c",(0,i.kt)("inlineCode",{parentName:"p"},"modprobe"),"\u52a0\u8f7d"),(0,i.kt)("p",null,"\u5efa\u8bae\u7528modprobe\uff0c\u80fd\u591f\u667a\u80fd\u5206\u6790\u6a21\u5757\u7684\u4f9d\u8d56\u5173\u7cfb\u8f7d\u5165\u5230\u5185\u6838"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u9ed8\u8ba4\u53bb/lib/modules/kernel-version(\u6bd4\u59824.2.1)\u5bfb\u627e\u6a21\u5757")),(0,i.kt)("p",null,"\u9a71\u52a8\u5378\u8f7d\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"rmmod "),"\u6216\u8005",(0,i.kt)("inlineCode",{parentName:"p"},"modprobe -r ")),(0,i.kt)("p",null,"modprobe\u53ef\u80fd\u4f1a\u5378\u8f7d\u4f9d\u8d56\u5173\u7cfb\u7684\u6a21\u5757\uff0c\u63a8\u8350rmmod"),(0,i.kt)("h4",{id:"\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c"},"\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u51fd\u6570\u539f\u578b\uff1a")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"static inline int register_chrdev(unsigned int major, const char *name,const struct file_operations *fops)\nstatic inline void unregister_chrdev(unsigned int major, const char *name)\n")),(0,i.kt)("p",null,"fops\u5c31\u662f\u8bbe\u5907\u7684\u64cd\u4f5c\u51fd\u6570\u96c6\u5408\uff0c\u6bd4\u5982open\u3001release"),(0,i.kt)("h3",{id:"linux\u8bbe\u5907\u53f7"},"Linux\u8bbe\u5907\u53f7"),(0,i.kt)("p",null,"\u5206\u4e3a\u4e3b\u6b21\u8bbe\u5907\u53f7\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"dev_t"),"\u524d12\u4f4d\u4e3a\u4e3b\u8bbe\u5907\u53f7\uff080-4095\uff09\u540e20\u4f4d\u4e3a\u6b21\u8bbe\u5907\u53f7"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"dev_t")," \u5b9a\u4e49\u5728\u6587\u4ef6 ",(0,i.kt)("inlineCode",{parentName:"p"},"include/linux/types.h")),(0,i.kt)("h4",{id:"\u52a8\u6001\u5206\u914d\u8bbe\u5907\u53f7"},"\u52a8\u6001\u5206\u914d\u8bbe\u5907\u53f7"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"int alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name)\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"dev"),"\u4fdd\u5b58\u7533\u8bf7\u7684\u8bbe\u5907\u53f7"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"baseminor"),"\u6b21\u8bbe\u5907\u53f7\u8d77\u59cb\u5730\u5740\uff0c"),(0,i.kt)("li",{parentName:"ol"},"alloc_chrdev_region \u53ef\u4ee5\u7533\u8bf7\u4e00\u6bb5\u8fde\u7eed\u7684\u591a\u4e2a\u8bbe\u5907\u53f7\uff0c\u8fd9\u4e9b\u8bbe\u5907\u53f7\u7684\u4e3b\u8bbe\u5907\u53f7\u4e00\u6837\uff0c\u4f46\u662f\u6b21\u8bbe\u5907\u53f7\u4e0d\u540c\uff0c\u6b21\u8bbe\u5907\u53f7\u4ee5 baseminor \u4e3a\u8d77\u59cb\u5730\u5740\u5730\u5740\u5f00\u59cb\u9012\u589e\u3002\u4e00\u822c baseminor \u4e3a 0\uff0c\u4e5f\u5c31\u662f\u8bf4\u6b21\u8bbe\u5907\u53f7\u4ece 0 \u5f00\u59cb\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u6570\u91cf"),(0,i.kt)("li",{parentName:"ol"},"\u8bbe\u5907\u540d")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\uff0c\u5185\u6838\u4e0d\u80fd\u8bbf\u95ee\u7528\u6237\u7a7a\u95f4\uff0c\u53ef\u80fd\u662f\u865a\u62df\u5185\u5b58\u7684\u95ee\u9898"),(0,i.kt)("p",{parentName:"admonition"},"\u8981\u91c7\u7528copy_to_user \u51fd\u6570\u6765\u5b8c\u6210\u5185\u6838\u7a7a\u95f4\u7684\u6570\u636e\u5230\u7528\u6237\u7a7a\u95f4\u7684\u590d\u5236"),(0,i.kt)("p",{parentName:"admonition"},"\u8fd8\u6709\u4e2a\u662fcopy_from_user"),(0,i.kt)("pre",{parentName:"admonition"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"static inline long copy_to_user(void __user *to, const void *from, unsigned long n)\n"))),(0,i.kt)("h3",{id:"led\u9a71\u52a8"},"LED\u9a71\u52a8"),(0,i.kt)("h4",{id:"ioremap\u5b8f"},"ioremap\u5b8f"),(0,i.kt)("p",null,"\u83b7\u53d6\u7269\u7406\u5730\u5740\u7684\u865a\u62df\u5730\u5740\uff0c\u5b9a\u4e49\u5728arch/arm/include/asm/io.h \u6587\u4ef6\u4e2d"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"#define ioremap(cookie,size) __arm_ioremap((cookie), (size),\nMT_DEVICE)\n")),(0,i.kt)("p",null,"\u5177\u4f53\u7ec6\u8282\u5c31\u4e0d\u60f3\u5173\u4e86\uff0c \u53ea\u9700\u8981\u77e5\u9053cookie->",(0,i.kt)("inlineCode",{parentName:"p"},"\u7269\u7406addr"),"\uff0csize\u662f\u5bc4\u5b58\u5668\u7684\u4f4d\u6570\uff0c\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"SW_MUX_GPIO1_IO03 = ioremap(SW_MUX_GPIO1_IO03_BASE, 4);\n")),(0,i.kt)("h4",{id:"iounmap-\u5b8f"},"iounmap \u5b8f"),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("p",{parentName:"admonition"},"\u7528\u4e8e\u91ca\u653eioremap\u6240\u505a\u7684\u6620\u5c04")),(0,i.kt)("h4",{id:"io\u5185\u5b58\u8bbf\u95ee\u51fd\u6570"},"IO\u5185\u5b58\u8bbf\u95ee\u51fd\u6570"),(0,i.kt)("p",null,"\u8fd9\u91cc\u7684IO\u4e0d\u662fGPIO\uff0c\u662f\u8f93\u5165\u8f93\u51fa\u7684\u90a3\u4e2a\u3002"),(0,i.kt)("p",null,"I/O\u6709\u4e24\u4e2a\u6982\u5ff5\uff1a",(0,i.kt)("inlineCode",{parentName:"p"},"IO\u7aef\u53e3"),"\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"IO\u5185\u5b58")),(0,i.kt)("blockquote",null,(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"IO\u5185\u5b58\uff1aIO\u5185\u5b58\u53c8\u79f0\u4e3aMemory-Mapped I/O(MMIO)\uff0c\u8be5IO\u7a7a\u95f4\u5904\u5728CPU\u7a7a\u95f4\u8303\u56f4\u5185\uff0cIO\u5185\u5b58\u548c\u666e\u901a\u7684\u5185\u5b58\u6ca1\u4ec0\u4e48\u533a\u522b\uff0c\u4e24\u8005\u90fd\u662f\u901a\u8fc7CPU\u7684\u5730\u5740\u603b\u7ebf\u548c\u63a7\u5236\u603b\u7ebf\u53d1\u9001\u7535\u5e73\u4fe1\u53f7\u8fdb\u884c\u8bbf\u95ee\uff0c\u518d\u901a\u8fc7\u6570\u636e\u603b\u7ebf\u8bfb\u5199\u6570\u636e\u3002\u8981\u60f3\u64cd\u7eb5\u8be5IO\u5c31\u5f97\u9996\u5148\u5c06\u8be5IO\u6620\u5c04\u5230CPU\u7684\u5730\u5740\u4e2d\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u8bbf\u95ee\u8be5IO\uff0c\u5982\u540c\u8bbf\u95ee\u5185\u5b58\u3002\u5927\u591a\u6570\u5d4c\u5165\u5f0f\u8bbe\u5907\u90fd\u5c5e\u4e8e\u6b64\u3002"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"IO\u7aef\u53e3\uff1a\u53c8\u79f0\u4e3aPort(PIO),\u8be5IO\u7684\u7a7a\u95f4\u4e0eCPU\u7a7a\u95f4\u76f8\u4e92\u72ec\u7acb\uff0c\u4e24\u8005\u4e92\u76f8\u72ec\u7acb\uff0c\u76f8\u4e92\u4e0d\u5e72\u6270\uff0c\u8fd9\u79cd\u7c7b\u578bIO\u5728X86\u4e2d\u6bd4\u8f83\u5e38\u89c1\uff0c\u8be5IO\u7aef\u53e3\u6709\u72ec\u7acb\u7684\u7a7a\u95f4\uff0c\u6240\u4ee5CPU\u8981\u60f3\u8bbf\u95ee\u8be5\u7aef\u53e3\u5c31\u5f97\u901a\u8fc7\u4e00\u4e9b\u4e13\u6709\u51fd\u6570\u6216\u8005\u6307\u4ee4\u3002")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://zhuanlan.zhihu.com/p/579146985"},"IO \u7aef\u53e3\u548cIO \u5185\u5b58\uff08\u539f\u7406\u7bc7\uff09 - \u77e5\u4e4e (zhihu.com)")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://zhikunhuo.blog.csdn.net/article/details/114600308"},"IO \u7aef\u53e3\u548cIO \u5185\u5b58\uff08\u539f\u7406\u7bc7\uff09_io\u5185\u5b58\u548cio\u7aef\u53e3\u7684\u533a\u522b_Huo\u7684\u85cf\u7ecf\u9601\u7684\u535a\u5ba2-CSDN\u535a\u5ba2")),(0,i.kt)("p",{parentName:"li"},"\u5f88\u660e\u663e\u6211\u6ca1\u770b\u61c2\uff0c\u4f46\u662f\u4f30\u8ba1\u662f\u4e00\u7cfb\u5217\u5f88\u96be\u641e\u6382\u7684\u4e1c\u897f")))),(0,i.kt)("p",null,"\u4f46\u662f\u6ca1\u5173\u7cfb\uff0cARM\u53ea\u6709IO\u5185\u5b58\u8fd9\u4e00\u8bf4"),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("p",{parentName:"admonition"},"\u867d\u8bf4IO\u5185\u5b58\u53ea\u8981\u6620\u5c04\u4e4b\u540e\u5c31\u64cd\u4f5c\u5185\u5b58\u76f4\u63a5\u7528\u6307\u9488\u8bbf\u95ee\u8fd9\u4e9b\u5730\u5740\uff0c\u4f46Linux\u5185\u6838\u4e0d\u63a8\u8350\u8fd9\u4e48\u505a\uff08idk\u554a"),(0,i.kt)("p",{parentName:"admonition"},"\u63a8\u8350\u4f7f\u7528\u4e00\u7ec4\u64cd\u4f5c\u5bf9\u6620\u5c04\u540e\u7684\u5185\u5b58\u8bbf\u95ee"),(0,i.kt)("ol",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8bfb\u64cd\u4f5c"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"u8  readb(const volatile void __iomem *addr)\nu16 readw(const volatile void __iomem *addr)\nu32 readl(const volatile void __iomem *addr)\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u5199"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void writeb(u8 value, volatile void __iomem *addr)\nvoid writew(u16 value, volatile void __iomem *addr)\nvoid writel(u32 value, volatile void __iomem *addr)\n"))))),(0,i.kt)("h4",{id:"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u53f7"},"\u5206\u914d\u548c\u91ca\u653e\u8bbe\u5907\u53f7"),(0,i.kt)("p",null,"\u4e0b\u5217dev\u90fd\u662f\u8bbe\u5907\u53f7"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u8bbe\u5907\u53f7\uff1a")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"int alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name)\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u5982\u679c\u6307\u5b9a\u4e3b\u6b21\u8bbe\u5907\u53f7")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"int register_chrdev_region(dev_t from, unsigned count, const char *name)\n")))),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"\u6ce8\u9500\u8bbe\u5907\u53f7"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void unregister_chrdev_region(dev_t from, unsigned count)\n")))),(0,i.kt)("p",null,"\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'int major;//\u4e3b\u8bbe\u5907\u53f7\nint minor;//\u6b21\u8bbe\u5907\u53f7\ndev_t devid;//\u8bbe\u5907\u53f7\n\nif(major){  //\u5982\u679c\u5b9a\u4e49\u4e86\u8bbe\u5907\u53f7\n    devid=MKDEV(major,0);//\u5927\u90e8\u5206\u9a71\u52a8\u6b21\u8bbe\u5907\u53f7\u90fd\u9009\u62e9 0\n    register_chrdev_region(devid,1,"\u8bbe\u5907\u540d");\n    \n}else{\n    alloc_chrdev_region(&devid, 0, 1, "test"); /* \u7533\u8bf7\u8bbe\u5907\u53f7     */\n    major = MAJOR(devid);   //\u83b7\u53d6\u5206\u914d\u53f7\u7684\u4e3b\u8bbe\u5907\u53f7\n    minor = MINOR(devid);   //\u83b7\u53d6\u5206\u914d\u53f7\u7684\u6b21\u8bbe\u5907\u53f7\n}\n//\u6ce8\u9500\u8bbe\u5907\u53f7\nunregister_chrdev_region(devid,1);\n')),(0,i.kt)("h4",{id:"\u65b0\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c\u65b9\u6cd5"},"\u65b0\u5b57\u7b26\u8bbe\u5907\u6ce8\u518c\u65b9\u6cd5"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u5b57\u7b26\u8bbe\u5907\u7ed3\u6784"),(0,i.kt)("p",{parentName:"li"},"Linux\u7528\u4e00\u4e2a\u7ed3\u6784",(0,i.kt)("inlineCode",{parentName:"p"},"cdev"),"\u6765\u8868\u793a\u4e00\u4e2a\u5b57\u7b26\u8bbe\u5907"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct cdev {\n    struct kobject kobj;\n    struct module *owner;\n    const struct file_operations *ops;\n    struct list_head list;\n    dev_t dev;\n    unsigned int count;\n};\n")),(0,i.kt)("p",{parentName:"li"},"\u6709\u6bd4\u8f83\u719f\u6089\u7684\u662fops\u548cowner\u4e86")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"cdv_init"),"\u51fd\u6570"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void cdev_init(struct cdev *, const struct file_operations *);\n")),(0,i.kt)("p",{parentName:"li"},"\u5728\u7528\u8fd9\u4e2a\u4e4b\u524d\u9700\u8981\u65b0\u5efa\u4e00\u4e2afop\u548ccdev\u7ed3\u6784\u4f53\n\u4e24\u4e2a\u7684owner\u90fd\u7528THIS_MODULE\uff0c\u539f\u56e0\u5728",(0,i.kt)("a",{parentName:"p",href:"/c-study-notes#this_module"},"\u8fd9\u91cc"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"cdev_add"),"\u51fd\u6570"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"int cdev_add(struct cdev *, dev_t, unsigned);\n")),(0,i.kt)("p",{parentName:"li"},"\u5c06",(0,i.kt)("strong",{parentName:"p"},"\u521d\u59cb\u5316\u597d"),"\u7684cdev\uff0c\u5411\u7cfb\u7edf\u6dfb\u52a0\u5b57\u7b26\u8bbe\u5907")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"cdev_del "),"\u51fd\u6570"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void cdev_del(struct cdev *);\n")))),(0,i.kt)("h4",{id:"\u521b\u5efa\u8bbe\u5907\u8282\u70b9"},"\u521b\u5efa\u8bbe\u5907\u8282\u70b9"),(0,i.kt)("p",null,"\u76f8\u5bf9\u4e8e\u524d\u9762\u7684\u9700\u8981\u81ea\u5df1\u624b\u52a8",(0,i.kt)("inlineCode",{parentName:"p"},"mknod"),"\u521b\u5efa\u8bbe\u5907\u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u52a8\u521b\u5efa"),(0,i.kt)("p",null,"\u5229\u7528busybox\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"mdev"),"\uff0c\u662fudev\u7684\u7b80\u5316\u7248\u672c\uff0clinux\u4e0b\u901a\u8fc7udv\u6765\u5b9e\u73b0\u8bbe\u5907\u6587\u4ef6\u7684\u521b\u5efa\u548c\u5220\u9664\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u68c0\u6d4b\u7cfb\u7edf\u4e2d\u786c\u4ef6\u8bbe\u5907\u72b6\u6001"),"\uff0c\u4ee5\u6b64\u6765\u521b\u5efa\u6216\u8005\u5220\u9664\u8bbe\u5907\u6587\u4ef6."),(0,i.kt)("p",null,"Linux \u7cfb\u7edf\u4e2d\u7684\u70ed\u63d2\u62d4\u4e8b\u4ef6\u4e5f\u7531  mdev \u7ba1\u7406\uff0c\u5728/etc/init.d/rcS \u6587\u4ef6\u4e2d\u5982\u4e0b\u8bed\u53e5\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"echo /sbin/mdev > /proc/sys/kernel/hotplug\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u521b\u5efa\u548c\u5220\u9664\u7c7b"),"\uff1a"),(0,i.kt)("p",{parentName:"li"},"\u81ea\u52a8\u521b\u5efa\u8bbe\u5907\u8282\u70b9\u7684\u5de5\u4f5c\u662f\u5728\u9a71\u52a8\u7a0b\u5e8f\u7684\u5165\u53e3\u51fd\u6570\u4e2d\u5b8c\u6210\u7684\uff0c\u4e00\u822c\u5728 cdev_add \u51fd\u6570\u540e\u9762\u6dfb\u52a0\u81ea\u52a8\u521b\u5efa\u8bbe\u5907\u8282\u70b9\u76f8\u5173\u4ee3\u7801\u3002"),(0,i.kt)("p",{parentName:"li"},"\u9996\u5148\u8981\u521b\u5efa\u4e00\u4e2a class \u7c7b\uff0cclass\u662f\u4e2a\u7ed3\u6784\u4f53\uff0c\u5b9a\u4e49\u5728\u6587\u4ef6include/linux/device.h \u91cc\u9762\u3002class_create \u662f\u7c7b\u521b\u5efa\u51fd\u6570\uff0cclass_create \u662f\u4e2a\u5b8f\u5b9a\u4e49\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"#define class_create(owner, name)       \\\n({                      \\\n    static struct lock_class_key __key; \\\n    __class_create(owner, name, &__key);    \\\n})\nstruct class *__class_create(struct module *owner, const char *name,\n                 struct lock_class_key *key);\n")),(0,i.kt)("p",{parentName:"li"},"\u7528\u4e00\u4e2aclass\u6307\u9488\u63a5\u6536\uff0c\u6254\u8fdb\u53bbowner\u548c\u7c7b\u540d"),(0,i.kt)("p",{parentName:"li"},"\u9700\u8981\u5378\u8f7d\u9a71\u52a8\u7684\u65f6\u5019\u5c31\u5220\u9664\u7c7b\u5c31\u597d"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void class_destroy(struct class *cls);\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u521b\u5efa\u8bbe\u5907"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct device *device_create(struct class *class, struct device *parent, dev_t devt, void *drvdata, const char *fmt, ...)\n")),(0,i.kt)("p",{parentName:"li"},"\u53c2\u6570\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"\u7c7b"),(0,i.kt)("li",{parentName:"ol"},"parent\u7236\u8bbe\u5907\uff1a\u4e00\u822c\u4e3aNULL"),(0,i.kt)("li",{parentName:"ol"},"devt\u662f\u8bbe\u5907\u53f7"),(0,i.kt)("li",{parentName:"ol"},"drvdata\u4e00\u822c\u4e5f\u4e3aNULL"),(0,i.kt)("li",{parentName:"ol"},"fmt\u662f\u8bbe\u5907\u540d")),(0,i.kt)("p",{parentName:"li"},"\u5378\u8f7d\u9a71\u52a8\u5c31\u5220\u9664\u8bbe\u5907"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void device_destroy(struct class *class, dev_t devt)\n")))),(0,i.kt)("p",null,"\u793a\u4f8b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'struct class *class;   /* \u7c7b*/\nstruct device *device; /* \u8bbe\u5907 */\ndev_t devid;           // \u8bbe\u5907\u53f7\n\n/* \u9a71\u52a8\u5165\u53e3\u51fd\u6570 */\n\nstatic int __init led_init(void)\n{\n    /* \u521b\u5efa\u7c7b */\n    class = class_create(THIS_MODULE, "xxx");\n    /* \u521b\u5efa\u8bbe\u5907 */\n    device = device_create(class, NULL, devid, NULL, "xxx");\n    return 0;\n}\n\n/* \u9a71\u52a8\u51fa\u53e3\u51fd\u6570    */\nstatic void __exit led_exit(void)\n{\n    /* \u5220\u9664\u8bbe\u5907    */\n    device_destroy(newchrled.class, newchrled.devid);\n    /* \u5220\u9664\u7c7b           */\n    class_destroy(newchrled.class);\n}\n\nmodule_init(led_init);\nmodule_exit(led_exit);\n')),(0,i.kt)("p",null,"\u4e4b\u540e\u8bbe\u7f6e\u79c1\u6709\u6570\u636e"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"/* \u8bbe\u5907\u7ed3\u6784\u4f53 */\nstruct test_dev\n{\n    dev_t devid;           /* \u8bbe\u5907\u53f7*/\n    struct cdev cdev;      /* cdev*/\n    struct class *class;   /* \u7c7b */\n    struct device *device; /* \u8bbe\u5907*/\n    int major;             /* \u4e3b\u8bbe\u5907\u53f7 */\n    int minor;             /* \u6b21\u8bbe\u5907\u53f7 */\n};\n\nstruct test_dev testdev;\n\n/* open \u51fd\u6570 */\nstatic int test_open(struct inode *inode, struct file *filp)\n{\n    filp->private_data = &testdev; /* \u8bbe\u7f6e\u79c1\u6709\u6570\u636e */\n    return 0;\n}\n")),(0,i.kt)("p",null,"\u5728  open \u51fd\u6570\u91cc\u9762\u8bbe\u7f6e\u597d\u79c1\u6709\u6570\u636e\u4ee5\u540e\uff0c\u5728  write\u3001read\u3001close \u7b49\u51fd\u6570\u4e2d\u76f4\u63a5\u8bfb\u53d6  private_data \u5373\u53ef\u5f97\u5230\u8bbe\u5907\u7ed3\u6784\u4f53\u3002"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u793a\u4f8b\uff1a")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/ide.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/gpio.h>\n#include <linux/cdev.h>\n#include <linux/device.h>\n#include <asm/mach/map.h>\n#include <asm/uaccess.h>\n#include <asm/io.h>\n\n#define NEWCHRLED_CNT 1             // \u8bbe\u5907\u4e2a\u6570\n#define NEWCHRLED_NAME "newcharled" // \u8bbe\u5907\u540d\n#define LEDOFF 0\n#define LEDON 1\n\n// \u5bc4\u5b58\u5668\u7269\u7406\u5730\u5740\n#define CCM_CCGR1_BASE (0X020C406C)\n#define SW_MUX_GPIO1_IO03_BASE (0X020E0068)\n#define SW_PAD_GPIO1_IO03_BASE (0X020E02F4)\n#define GPIO1_DR_BASE (0X0209C000)\n#define GPIO1_GDIR_BASE (0X0209C004)\n\n// \u6620\u5c04\u540e\u7684\u5bc4\u5b58\u5668\u865a\u62df\u5730\u5740\u6307\u9488\nstatic void __iomem *IMX6U_CCM_CCGR1;\nstatic void __iomem *SW_MUX_GPIO1_IO03;\nstatic void __iomem *SW_PAD_GPIO1_IO03;\nstatic void __iomem *GPIO1_DR;\nstatic void __iomem *GPIO1_GDIR;\n\n/* newchrled \u8bbe\u5907\u7ed3\u6784\u4f53 */\nstruct newchrled_dev\n{\n    dev_t devid; // \u8bbe\u5907\u53f7\n    struct cdev cdev;\n    struct class *class;   // \u7c7b\n    struct device *device; // \u8bbe\u5907\n    int major;             // \u4e3b\u8bbe\u5907\u53f7\n    int minor;             // \u6b21\u8bbe\u5907\u53f7\n} newchrled;               // \u65b0\u5efaled\u8bbe\u5907\n\nvoid led_switch(u8 sta)\n{\n    u32 val = 0;\n    if (sta == LEDON)\n    {\n        val = readl(GPIO1_DR);\n        val &= ~(1 << 3);\n        writel(val, GPIO1_DR);\n    }\n    else if (sta == LEDOFF)\n    {\n        val = readl(GPIO1_DR);\n        val |= (1 << 3);\n        writel(val, GPIO1_DR);\n    }\n}\n\nstatic int led_open(struct inode *inode, struct file *filp)\n{\n    filp->private_data = &newchrled;\n    return 0;\n}\n\nstatic ssize_t led_read(struct file *filp, char __user *buf, size_t cnt, loff_t *offt)\n{\n    return 0;\n}\n\nstatic ssize_t led_write(struct file *filp, const char __user *buf, size_t cnt, loff_t *offt)\n{\n    int retvalue;\n    unsigned char databuf[1];\n    unsigned char ledstat;\n\n    retvalue = copy_from_user(databuf, buf, cnt);\n    if (retvalue < 0)\n    {\n        printk("kernel write failed!\\r\\n");\n        return -EFAULT;\n    }\n\n    ledstat = databuf[0]; // \u83b7\u53d6\u72b6\u6001\u503c\n    if (ledstat == LEDON)\n    {\n        led_switch(LEDON); /* \u6253\u5f00 LED \u706f */\n    }\n    else if (ledstat == LEDOFF)\n    {\n        led_switch(LEDOFF); /* \u5173\u95ed LED \u706f */\n    }\n    return 0;\n}\nstatic int led_release(struct inode *inode, struct file *filp)\n{\n    return 0;\n}\n\n// \u8bbe\u5907\u64cd\u4f5c\u51fd\u6570\nstatic struct file_operations newchrled_fops = {\n    .owner = THIS_MODULE,\n    .open = led_open,\n    .read = led_read,\n    .write = led_write,\n    .release = led_release,\n};\n\nstatic int __init led_init(void)\n{\n    u32 val = 0;\n\n    /* \u521d\u59cb\u5316 LED */\n    /* 1\u3001\u5bc4\u5b58\u5668\u5730\u5740\u6620\u5c04    */\n    IMX6U_CCM_CCGR1 = ioremap(CCM_CCGR1_BASE, 4);\n    SW_MUX_GPIO1_IO03 = ioremap(SW_MUX_GPIO1_IO03_BASE, 4);\n    SW_PAD_GPIO1_IO03 = ioremap(SW_PAD_GPIO1_IO03_BASE, 4);\n    GPIO1_DR = ioremap(GPIO1_DR_BASE, 4);\n    GPIO1_GDIR = ioremap(GPIO1_GDIR_BASE, 4);\n\n    /* 2\u3001\u4f7f\u80fd GPIO1 \u65f6\u949f   */\n    val = readl(IMX6U_CCM_CCGR1);\n    val &= ~(3 << 26); /* \u6e05\u695a\u4ee5\u524d\u7684\u8bbe\u7f6e    */\n    val |= (3 << 26);  /* \u8bbe\u7f6e\u65b0\u503c    */\n    writel(val, IMX6U_CCM_CCGR1);\n\n    /* 3\u3001\u8bbe\u7f6e GPIO1_IO03 \u7684\u590d\u7528\u529f\u80fd\uff0c\u5c06\u5176\u590d\u7528\u4e3a\n     *    GPIO1_IO03\uff0c\u6700\u540e\u8bbe\u7f6e IO \u5c5e\u6027\u3002\n     */\n    writel(5, SW_MUX_GPIO1_IO03);\n\n    /* \u5bc4\u5b58\u5668 SW_PAD_GPIO1_IO03 \u8bbe\u7f6e IO \u5c5e\u6027    */\n    writel(0x10B0, SW_PAD_GPIO1_IO03);\n\n    /* 4\u3001\u8bbe\u7f6e GPIO1_IO03 \u4e3a\u8f93\u51fa\u529f\u80fd    */\n    val = readl(GPIO1_GDIR);\n    val &= ~(1 << 3); /* \u6e05\u9664\u4ee5\u524d\u7684\u8bbe\u7f6e    */\n    val |= (1 << 3);  /* \u8bbe\u7f6e\u4e3a\u8f93\u51fa   */\n    writel(val, GPIO1_GDIR);\n\n    /* 5\u3001\u9ed8\u8ba4\u5173\u95ed LED */\n    val = readl(GPIO1_DR);\n    val |= (1 << 3);\n    writel(val, GPIO1_DR);\n\n    /* \u6ce8\u518c\u5b57\u7b26\u8bbe\u5907\u9a71\u52a8    */\n    /* 1\u3001\u521b\u5efa\u8bbe\u5907\u53f7    */\n    if (newchrled.major)\n    { /*  \u5b9a\u4e49\u4e86\u8bbe\u5907\u53f7    */\n        newchrled.devid = MKDEV(newchrled.major, 0);\n        register_chrdev_region(newchrled.devid, NEWCHRLED_CNT, NEWCHRLED_NAME);\n    }\n    else\n    {\n        /* \u6ca1\u6709\u5b9a\u4e49\u8bbe\u5907\u53f7    */\n        alloc_chrdev_region(&newchrled.devid, 0, NEWCHRLED_CNT,\n                            NEWCHRLED_NAME);      /* \u7533\u8bf7\u8bbe\u5907\u53f7    */\n        newchrled.major = MAJOR(newchrled.devid); /* \u83b7\u53d6\u4e3b\u8bbe\u5907\u53f7 */\n        newchrled.minor = MINOR(newchrled.devid); /* \u83b7\u53d6\u6b21\u8bbe\u5907\u53f7 */\n    }\n    printk("newchrled major=%d,minor=%d\\r\\n", newchrled.major, newchrled.minor);    \n\n    /* 2\u3001\u521d\u59cb\u5316  cdev */\n    newchrled.cdev.owner = THIS_MODULE;\n    cdev_init(&newchrled.cdev, &newchrled_fops);\n\n    /* 3\u3001\u6dfb\u52a0\u4e00\u4e2a  cdev */\n    cdev_add(&newchrled.cdev, newchrled.devid, NEWCHRLED_CNT);\n\n    /* 4\u3001\u521b\u5efa\u7c7b    */\n    newchrled.class = class_create(THIS_MODULE, NEWCHRLED_NAME);\n    if (IS_ERR(newchrled.class))\n    {\n        return PTR_ERR(newchrled.class);\n    }\n    /* 5\u3001\u521b\u5efa\u8bbe\u5907    */\n    newchrled.device = device_create(newchrled.class, NULL, newchrled.devid, NULL, NEWCHRLED_NAME);\n    if (IS_ERR(newchrled.device))\n    {\n        return PTR_ERR(newchrled.device);\n    }\n\n    return 0;\n}\n\nstatic void __exit led_exit(void)\n{\n    /* \u53d6\u6d88\u6620\u5c04   */\n    iounmap(IMX6U_CCM_CCGR1);\n    iounmap(SW_MUX_GPIO1_IO03);\n    iounmap(SW_PAD_GPIO1_IO03);\n    iounmap(GPIO1_DR);\n    iounmap(GPIO1_GDIR);\n\n    /* \u6ce8\u9500\u5b57\u7b26\u8bbe\u5907    */\n    cdev_del(&newchrled.cdev); /*  \u5220\u9664 cdev */\n    unregister_chrdev_region(newchrled.devid, NEWCHRLED_CNT);\n\n    device_destroy(newchrled.class, newchrled.devid);\n    class_destroy(newchrled.class);\n}\n\nmodule_init(led_init);\nmodule_exit(led_exit);\n')),(0,i.kt)("h2",{id:"\u8bbe\u5907\u6811"},"\u8bbe\u5907\u6811"),(0,i.kt)("h3",{id:"basic-concept"},"Basic concept"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"DTS\u3001DTB\u3001DTC"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"DTS"),"\uff1a\u8bbe\u5907\u6811\u6e90\u7801\u6587\u4ef6"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"DTB"),"\uff1a\u8bbe\u5907\u6811\u7f16\u8bd1\u540e\u4e8c\u8fdb\u5236\u6587\u4ef6"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"DTC"),"\uff1a\u7f16\u8bd1\u5de5\u5177\uff0c\u5728scripts/dtc\u4e0b"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"make dtbs"),"\u7f16\u8bd1dts\u6587\u4ef6")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8981\u60f3\u7f16\u8bd1\u51fadtb\uff0c\u9700\u8981\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"arch/arm/boot/dts/Makefile"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"dtb-$(CONFIG_SOC_IMX6ULL) += \\"),"\u52a0\u5165\u81ea\u5df1\u7684dtb")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8bbe\u5907\u6811\u5934\u6587\u4ef6",(0,i.kt)("inlineCode",{parentName:"p"},".dtsi")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},'#include <dt-bindings/input/input.h>\n#include "imx6ull.dtsi"\n')),(0,i.kt)("p",{parentName:"li"},"\u53ef\u4ee5\u5f15\u7528.h\u548c.dtsi\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u5f15\u7528.dts"),(0,i.kt)("p",{parentName:"li"},"\u4e00\u822c.dtsi \u6587\u4ef6\u7528\u4e8e\u63cf\u8ff0 SOC \u7684\u5185\u90e8\u5916\u8bbe\u4fe1\u606f\uff0c\u6bd4\u5982 CPU \u67b6\u6784\u3001\u4e3b\u9891\u3001\u5916\u8bbe\u5bc4\u5b58\u5668\u5730\u5740\u8303\u56f4\uff0c\u6bd4\u5982 UART\u3001IIC \u7b49\u7b49\u3002\n\u6bd4\u5982 imx6ull.dtsi \u5c31\u662f\u63cf\u8ff0 I.MX6ULL \u8fd9\u9897 SOC \u5185\u90e8\u5916\u8bbe\u60c5\u51b5\u4fe1\u606f")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8bbe\u5907\u8282\u70b9"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/"),(0,i.kt)("strong",{parentName:"p"},"\u6839\u8282\u70b9"),"\uff0c\u5982\u679cimx6ull.dtsi\u548cimx6ull-alientek-emmc.dts \u8fd9\u4e24\u4e2a\u6587\u4ef6\u90fd\u6709\u4e00\u4e2a\u201c/\u201d\u6839\u8282\u70b9\uff0c\u4e24\u4e2a\u6839\u8282\u70b9\u4f1a\u5408\u5e76\u6210\u4e3a\u4e00\u4e2a\u6839\u8282\u70b9")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u5b50\u8282\u70b9"),"\u547d\u540d\u65b9\u5f0f",(0,i.kt)("inlineCode",{parentName:"p"},"node-name@unit-address"),"\u6bd4\u5982",(0,i.kt)("inlineCode",{parentName:"p"},"interrupt-controller@00a01000"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"label\u6807\u7b7e"),"\u547d\u540d\u65b9\u5f0f\uff1a",(0,i.kt)("inlineCode",{parentName:"p"},"label: node-name@unit-address"),"\u6bd4\u5982",(0,i.kt)("inlineCode",{parentName:"p"},"cpu0:cpu@0"),"\u53ef\u4ee5\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"&cpu0"),"\u8bbf\u95ee\u8be5\u8282\u70b9")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8bbe\u5907\u6811\u51e0\u79cd\u6570\u636e\u5f62\u5f0f\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u5b57\u7b26\u4e32"),'\uff1acompatible = "arm,cortex-a7";\u4e5f\u53ef\u4ee5\u6210\u4e3a\u5b57\u7b26\u4e32\u5217\u8868\uff0c\u7528\u9017\u53f7\u9694\u5f00')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"32 \u4f4d\u65e0\u7b26\u53f7\u6574\u6570"),"\uff1areg=<0>;"),(0,i.kt)("p",{parentName:"li"},"reg\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u4e00\u7ec4\u503c\uff0c\u6bd4\u5982\uff1areg = <0 0x123456 100>;")))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u6807\u51c6\u5c5e\u6027\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"compatible"),"\uff1a\u517c\u5bb9\u6027\u5c5e\u6027\uff0c\u4e3a\u4e00\u4e2a\u5b57\u7b26\u4e32\u5217\u8868\uff0c\u7528\u4e8e\u5c06",(0,i.kt)("strong",{parentName:"p"},"\u8bbe\u5907\u548c\u9a71\u52a8"),"\u7ed1\u5b9a\u8d77\u6765\n\u683c\u5f0f\u5982\u4e0b\uff1a",(0,i.kt)("inlineCode",{parentName:"p"},'"manufacturer,model"'),'\nmanufacturer\u662f\u5382\u5546\uff0cmodel\u4e00\u822c\u662f\u6a21\u5757\u5bf9\u5e94\u7684\u9a71\u52a8\u540d\uff0c\u6bd4\u5982\ncompatible = "fsl,imx6ul-evk-wm8960","fsl,imx-audio-wm8960";\nfsl\u662f\u98de\u601d\u5361\u5c14\uff0c\u53f3\u8fb9\u8868\u793a\u9a71\u52a8\u6a21\u5757'),(0,i.kt)("p",{parentName:"li"},"\u8fd9\u4e2a\u8bbe\u5907\u9996\u5148\u4f7f\u7528\u7b2c\u4e00\u4e2a\u517c\u5bb9\u503c\u5728 Linux \u5185\u6838\u91cc\u9762\u67e5\u627e\uff0c\u770b\u770b\u80fd\u4e0d\u80fd\u627e\u5230\u4e0e\u4e4b\u5339\u914d\u7684\u9a71\u52a8\u6587\u4ef6\uff0c\u5982\u679c\u6ca1\u6709\u627e\u5230\u7684\u8bdd\u5c31\u4f7f\u7528\u7b2c\u4e8c\u4e2a\u517c\u5bb9\u503c\u67e5\u3002"),(0,i.kt)("p",{parentName:"li"},"\u4e00\u822c\u9a71\u52a8\u7a0b\u5e8f\u6587\u4ef6\u90fd\u4f1a\u6709\u4e00\u4e2a ",(0,i.kt)("strong",{parentName:"p"},"OF \u5339\u914d\u8868"),"\uff0c\u6b64 OF \u5339\u914d\u8868\u4fdd\u5b58\u7740\u4e00\u4e9b ",(0,i.kt)("strong",{parentName:"p"},"compatible \u503c"),"\uff0c\u5982\u679c\u8bbe\u5907\u8282\u70b9\u7684 compatible \u5c5e\u6027\u503c\u548c OF \u5339\u914d\u8868\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u503c\u76f8\u7b49\uff0c\u90a3\u4e48\u5c31\u8868\u793a\u8bbe\u5907\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u9a71\u52a8\u3002\u6bd4\u5982\u5728\u6587\u4ef6 imx-wm8960.c \u4e2d\u6709\u5982\u4e0b\u5185\u5bb9\uff1a"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{parentName:"p",src:"https://pic.imgdb.cn/item/65005a0b661c6c8e5401c261",alt:"\t"})),(0,i.kt)("p",{parentName:"li"},"\u524d\u9762\u4e09\u884c\u5c31\u662f\u5339\u914d\u8868\uff0c\u4e0b\u9762\u7684\u7ed3\u6784\u4f53\u4e3aplatform_driver\u7684\u9a71\u52a8\u6a21\u5f0f")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"model"),"\uff1a\u4e5f\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u4e00\u822c  model \u5c5e\u6027\u63cf\u8ff0\u8bbe\u5907\u6a21\u5757\u4fe1\u606f\uff0c\u6bd4\u5982\u540d\u5b57\u4ec0\u4e48\u7684"),(0,i.kt)("p",{parentName:"li"},'\u6bd4\u5982\uff1amodel = "wm8960-audio";')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"status"),"\uff1a\u8bbe\u5907\u72b6\u6001\u6709\u5173\uff0c\u5b57\u7b26\u4e32\n",(0,i.kt)("img",{parentName:"p",src:"https://pic.imgdb.cn/item/65005e2d661c6c8e5404343f",alt:"image-20230912204844763"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"#address-cells")," \u548c",(0,i.kt)("strong",{parentName:"p"},"#size-cells"),"\uff1a\nu32\u6574\u5f62\u3002 \u7528\u5728\u7528\u4e8e\u5b50\u8282\u70b9\u7684\u8bbe\u5907\u4e2d\uff0c\u63cf\u8ff0\u5b50\u8282\u70b9\u7684\u5730\u5740\naddress-cells\u51b3\u5b9a\u5b50\u8282\u70b9reg",(0,i.kt)("strong",{parentName:"p"},"\u5730\u5740\u7684\u5b57\u957f"),"\uff0csize-cells\u51b3\u5b9a\u5b50\u8282\u70b9reg\u5c5e\u6027\u4e2d",(0,i.kt)("strong",{parentName:"p"},"\u957f\u5ea6\u4fe1\u606f\u6240\u5360\u7684\u5b57\u957f")),(0,i.kt)("p",{parentName:"li"},"\u4e00\u822c reg \u5c5e\u6027\u90fd\u662f\u548c\u5730\u5740\u6709\u5173\u7684\u5185\u5bb9\uff0c\u548c\u5730\u5740\u76f8\u5173\u7684\u4fe1\u606f\u6709\u4e24\u79cd\uff1a\u8d77\u59cb\u5730\u5740\u548c\u5730\u5740\u957f\u5ea6\uff0creg \u5c5e\u6027\u7684\u683c\u5f0f\u4e00\u4e3a\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"reg = <address1 length1 address2 length2 address3 length3\u2026\u2026>\n")),(0,i.kt)("p",{parentName:"li"},"\u6bcf\u4e2a\u201caddress length\u201d\u7ec4\u5408\u8868\u793a\u4e00\u4e2a\u5730\u5740\u8303\u56f4\uff0c\u5176\u4e2d address \u662f\u8d77\u59cb\u5730\u5740\uff0clength \u662f\u5730\u5740\u957f\u5ea6\uff0c#address-cells \u8868\u660e address \u8fd9\u4e2a\u6570\u636e\u6240\u5360\u7528\u7684\u5b57\u957f\uff0c#size-cells \u8868\u660e length \u8fd9\u4e2a\u6570\u636e\u6240\u5360\u7528\u7684\u5b57\u957f\uff0c\u6bd4\u5982"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},'spi4 {\n    compatible = "spi-gpio";\n    #address-cells = <1>;\n    #size-cells = <0>;\n\n    gpio_spi: gpio_spi@0 {\n        compatible = "fairchild,74hc595";\n        reg = <0>;\n    };\n};\n\naips3: aips-bus@02200000 {\n   compatible = "fsl,aips-bus", "simple-bus";\n   #address-cells = <1>;\n   #size-cells = <1>;\n   dcp: dcp@02280000 {\n       compatible = "fsl,imx6sl-dcp";\n       reg = <0x02280000 0x4000>;\n   };\n};\n')),(0,i.kt)("p",{parentName:"li"},"\u7b2c\u4e00\u4e2aspi4\u7684\uff0c\u8bf4\u660e\u5979\u5b50\u8282\u70b9reg\u8d77\u59cb\u5730\u5740\u5b57\u957f1\uff0c\u5360\u75280")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"reg"),"\u5c5e\u6027")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"ranges"),"\uff1a"),(0,i.kt)("p",{parentName:"li"},"\u53ef\u4ee5\u4e3a\u7a7a\u6216\u8005\u6309\u7167(",(0,i.kt)("strong",{parentName:"p"},"child-bus-address,parent-bus-address,length"),")\u683c\u5f0f\u7f16\u5199\u7684\u6570\u5b57\u77e9\u9635\uff0cranges \u662f\u4e00\u4e2a",(0,i.kt)("strong",{parentName:"p"},"\u5730\u5740\u6620\u5c04/\u8f6c\u6362\u8868"),"\uff0cranges \u5c5e\u6027\u6bcf\u4e2a\u9879\u76ee\u7531\u5b50\u5730\u5740\u3001\u7236\u5730\u5740\u548c\u5730\u5740\u7a7a\u95f4\u957f\u5ea6\u8fd9\u4e09\u90e8\u5206\u7ec4\u6210\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"child-bus-address"),"\uff1a\u5b50\u603b\u7ebf\u5730\u5740\u7a7a\u95f4\u7684\u7269\u7406\u5730\u5740\uff0c\u7531\u7236\u8282\u70b9\u7684#address-cells \u786e\u5b9a\u6b64\u7269\u7406\u5730\u5740\u6240\u5360\u7528\u7684\u5b57\u957f\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"parent-bus-address"),"\uff1a\u7236\u603b\u7ebf\u5730\u5740\u7a7a\u95f4\u7684\u7269\u7406\u5730\u5740\uff0c\u540c\u6837\u7531\u7236\u8282\u70b9\u7684#address-cells \u786e\u5b9a\u6b64\u7269\u7406\u5730\u5740\u6240\u5360\u7528\u7684\u5b57\u957f\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"length"),"\uff1a\u5b50\u5730\u5740\u7a7a\u95f4\u7684\u957f\u5ea6\uff0c\u7531",(0,i.kt)("strong",{parentName:"li"},"\u7236\u8282\u70b9"),"\u7684#size-cells \u786e\u5b9a\u6b64\u5730\u5740\u957f\u5ea6\u6240\u5360\u7528\u7684\u5b57\u957f\u3002")),(0,i.kt)("p",{parentName:"li"},"\u5982\u679c ranges \u5c5e\u6027\u503c\u4e3a\u7a7a\u503c\uff0c\u8bf4\u660e\u5b50\u5730\u5740\u7a7a\u95f4\u548c\u7236\u5730\u5740\u7a7a\u95f4\u5b8c\u5168\u76f8\u540c\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u4e0d\u9700\u8981"),"\u8fdb\u884c\u5730\u5740\u8f6c\u6362\uff0c\u5bf9\u4e8e\u6211\u4eec\u6240\u4f7f\u7528\u7684 I.MX6ULL \u6765\u8bf4\uff0c\u5b50\u5730\u5740\u7a7a\u95f4\u548c\u7236\u5730\u5740\u7a7a\u95f4\u5b8c\u5168\u76f8\u540c\uff0c\u56e0\u6b64\u4f1a\u5728 imx6ull.dtsi\u4e2d\u627e\u5230\u5927\u91cf\u7684\u503c\u4e3a\u7a7a\u7684 ranges \u5c5e\u6027"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{parentName:"p",src:"https://pic.imgdb.cn/item/65011572661c6c8e5445c332",alt:"image-20230913095034298"})),(0,i.kt)("p",{parentName:"li"},"\u4e0d\u4e3a\u7a7a\uff1aranges = <0x0 0xe0000000 0x00100000>;"),(0,i.kt)("p",{parentName:"li"},"1024KB(0x00100000)\u7684\u5730\u5740\u8303\u56f4\uff0c\u5b50\u5730\u5740\u7a7a\u95f4\u7684\u7269\u7406\u8d77\u59cb\u5730\u5740\u4e3a 0x0\uff0c\u7236\u5730\u5740\u7a7a\u95f4\u7684\u7269\u7406\u8d77\u59cb\u5730\u5740\u4e3a 0xe0000000\u3002"),(0,i.kt)("p",{parentName:"li"},"reg = <0x4600 0x100>;"),(0,i.kt)("p",{parentName:"li"},"reg \u5c5e\u6027\u5b9a\u4e49\u4e86 serial \u8bbe\u5907\u5bc4\u5b58\u5668\u7684\u8d77\u59cb\u5730\u5740\u4e3a 0x4600\uff0c\u5bc4\u5b58\u5668\u957f\u5ea6\u4e3a 0x100\u3002 \u7ecf \u8fc7 \u5730 \u5740 \u8f6c \u6362\uff0c serial \u8bbe \u5907\u53ef \u4ee5 \u4ece 0xe0004600 \u5f00\u59cb\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\uff0c0xe0004600=0x4600+0xe0000000\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"name"),"\uff1a\u8001\u767b\u624d\u4f1a\u7528\u6765\u8bb0\u5f55\u8282\u70b9\u540d\u5b57")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"device_type")," \uff1a\u5b57\u7b26\u4e32\uff0c")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u7528\u4e8e\u63cf\u8ff0\u8bbe\u5907\u7684 FCode\uff0c\u4f46\u662f\u8bbe\u5907\u6811\u6ca1\u6709FCode\uff0c\u6240\u4ee5\u6b64\u5c5e\u6027\u4e5f\u88ab\u629b\u5f03 \u4e86\u3002\u6b64\u5c5e\u6027\u53ea\u80fd\u7528\u4e8e cpu\u8282\u70b9\u6216\u8005memory\u8282\u70b9 \u3002"),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},'cpu0: cpu@0 {\ncompatible = "arm,cortex-a7";\n',(0,i.kt)("strong",{parentName:"p"},'device_type = "cpu";'),"\nreg = <0>;"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u6839\u8282\u70b9compatible \u5c5e\u6027")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},' / {\n    model = "Freescale i.MX6 ULL 14x14 EVK Board";\n    compatible = "fsl,imx6ull-14x14-evk", "fsl,imx6ull";\n    ...\n    }\n')),(0,i.kt)("p",{parentName:"li"},"compatibles\u5c5e\u6027 \u7b2c\u4e00\u4e2a\u503c\u8868\u793a\u6240\u4f7f\u7528\u7684\u786c\u4ef6\u8bbe\u5907\u540d\u5b57\uff0c\u7b2c\u4e8c\u4e2a\u8868\u793aSOC\n",(0,i.kt)("strong",{parentName:"p"},"\u5982\u4f55\u77e5\u9053Linux\u5185\u6838\u652f\u4e0d\u652f\u6301\u8fd9\u4e2a\u8bbe\u5907")),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u4f7f\u7528\u8bbe\u5907\u6811\u4e4b\u524d\u7684\u8bbe\u5907\u5339\u914d\u65b9\u6cd5"),"\uff1a"),(0,i.kt)("p",{parentName:"li"},"uboot \u4f1a\u5411 Linux \u5185\u6838\u4f20\u9012\u4e00\u4e2a\u53eb\u505a machine id \u3002\u544a\u8bc9 Linux \u5185\u6838\u81ea\u5df1\u662f\u4e2a\u4ec0\u4e48\u8bbe\u5907\uff0c\u770b\u770b Linux \u5185\u6838\u662f\u5426\u652f\u6301"),(0,i.kt)("p",{parentName:"li"},"\u9488\u5bf9\u6bcf\u4e00\u4e2a\u8bbe\u5907(\u677f\u5b50)\uff0cLinux \u5185\u6838\u90fd\u7528 ",(0,i.kt)("strong",{parentName:"p"},"MACHINE_START")," \u548c ",(0,i.kt)("strong",{parentName:"p"},"MACHINE_END")),(0,i.kt)("p",{parentName:"li"},"\u6765\u5b9a\u4e49\u4e00\u4e2a machine_desc \u7ed3\u6784\u4f53\u6765\u63cf\u8ff0\u8fd9\u4e2a\u8bbe\u5907\uff0c\u6bd4\u5982\u5728\u6587\u4ef6 arch/arm/mach-imx/mach-\nmx35_3ds.c"),(0,i.kt)("p",{parentName:"li"},"\u5177\u4f53\u8df3\u8f6c\u5230\u6b63\u70b9\u76841123\u9875\u770b\u5427"),(0,i.kt)("p",{parentName:"li"},"machine id\u5728 mach-types.h \u6587\u4ef6\u4e2d")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u4f7f\u7528\u8bbe\u5907\u6811\u8bbe\u5907\u5339\u914d\u65b9\u6cd5"),"\uff1a"),(0,i.kt)("p",{parentName:"li"},"\u6362\u4e3a\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"DT_MACHINE_START"),"\u3002DT_MACHINE_START\u4e5f\u5b9a\u4e49\u5728\u6587\u4ef6 arch/arm/include/asm/mach/arch.h \u91cc\u9762"),(0,i.kt)("p",{parentName:"li"},"\u8fd9\u54e5\u4eec\u7684\u5b8f\u5b9a\u4e49\u4e0a\u548cMACHINE_START\u57fa\u672c\u76f8\u540c\uff0c\u53ea\u662f.nr\u7684\u8bbe\u7f6e\u4e0d\u540c\uff0c\u76f4\u63a5\u4e3a~0\u4e86"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},'static const char *imx6ul_dt_compat[] __initconst = {\n    "fsl,imx6ul",\n    "fsl,imx6ull",\n    NULL,\n};\n\nDT_MACHINE_START(IMX6UL, "Freescale i.MX6 Ultralite (Device Tree)")\n    .map_io     = imx6ul_map_io,\n    .init_irq   = imx6ul_init_irq,\n    .init_machine   = imx6ul_init_machine,\n    .init_late  = imx6ul_init_late,\n    .dt_compat  = imx6ul_dt_compat,\nMACHINE_END\n')),(0,i.kt)("p",{parentName:"li"},'\u91cd\u70b9\u5728.dt_compat\uff0c\u91cc\u9762\u7684\u517c\u5bb9\u503c\u548c\u8bbe\u5907\u6811compatible\u91cc\u7684\u5c5e\u6027\u76f8\u7b49\u5c31\u80fd\u6b63\u5e38\u542f\u52a8\u3002"fsl,imx6ull",'),(0,i.kt)("p",{parentName:"li"},"Linux \u5185\u6838\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"start_kernel")," \u51fd\u6570\u6765\u542f\u52a8\u5185\u6838\uff0cstart_kernel \u51fd\u6570\u4f1a\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"setup_arch")," \u51fd\u6570\u6765\u5339\u914dmachine_desc\uff0csetup_arch\u51fd\u6570\u5b9a\u4e49\u5728\u6587\u4ef6 arch/arm/kernel/setup.c \u4e2d"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void __init setup_arch(char **cmdline_p)\n{\n   const struct machine_desc *mdesc;\n\n   setup_processor();\n   mdesc = setup_machine_fdt(__atags_pointer);\n   if (!mdesc)\n        mdesc = setup_machine_tags(__atags_pointer,__machine_arch_type);\n   machine_desc = mdesc;\n   machine_name = mdesc->name;\n   ......\n }\n")),(0,i.kt)("p",{parentName:"li"},"\u7528setup_machine_fdt\u83b7\u53d6\u5339\u914d\u7684machine_desc\uff0catags\u5c31\u662fatags\u7684\u9996\u5730\u5740"),(0,i.kt)("p",{parentName:"li"},"\u51fd\u6570",(0,i.kt)("inlineCode",{parentName:"p"},"setup_machine_fdt"),"\u5728arch/arm/kernel/devtree.c \u4e2d\n\uff08\u8fd9\u54e5\u4eec\u5165\u53c2__atags_pointer\u770b\u4e0a\u53bb\u4e0d\u662f\u8981pointer\u5417\uff1f\uff1f\uff1f\uff0c\u600e\u4e48\u662fuint\uff1f"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"}," const struct machine_desc * __init setup_machine_fdt(unsigned int dt_phys)\n {\n    const struct machine_desc *mdesc, *mdesc_best = NULL;\n    ......\n \n    if (!dt_phys || !early_init_dt_verify(phys_to_virt(dt_phys)))\n       return NULL;\n    mdesc = of_flat_dt_match_machine(mdesc_best,arch_get_next_mach);\n    ......\n    __machine_arch_type = mdesc->nr;\n\n    return mdesc;\n }\n")),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"of_flat_dt_match_machine")," \u6765\u83b7\u53d6\u5339\u914d\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"machine_desc"),"\uff0c\u53c2\u6570mdesc_best\u662f\u9ed8\u8ba4\u7684machine_desc\uff08\u9ed8\u8ba4\u5c31\u662fNULL\u662f\u5427\uff0c\u53ef\u80fd\u5728\u4e0a\u9762\u521d\u59cb\u5316\u4e86")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u53c2\u6570",(0,i.kt)("inlineCode",{parentName:"p"},"arch_get_next_mach"),"\uff0c\u8fd9\u8001\u767b\u662f\u4e2a\u51fd\u6570"),(0,i.kt)("p",{parentName:"li"},"\u5339\u914d\u7684\u8fc7\u7a0b\u5c31\u662f\u5c06\u6839\u8282\u70b9\u7684compatible\u548c\u5185\u6838machine_desc\u7684.dt_compat\u6bd4\u8f83\uff0c\u800c\u8fd9\u4e2a\u51fd\u6570\u5c31\u662f\u83b7\u53d6\u5185\u6838\u7684machine_desc\u7ed3\u6784\u4f53"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},' const void * __init of_flat_dt_match_machine(const void *default_match,\n       const void * (*get_next_compat)(const char * const**))\n {\n    const void *data = NULL;\n    const void *best_data = default_match;\n    const char *const *compat;\n    unsigned long dt_root;\n    unsigned int best_score = ~1, score = 0;\n    \n    dt_root = of_get_flat_dt_root();\n    while ((data = get_next_compat(&compat))) {\n       score = of_flat_dt_match(dt_root, compat);\n       if (score > 0 && score < best_score) {\n          best_data = data;\n          best_score = score;\n       }\n    }\n    ......\n\n    pr_info("Machine model: %s\\n", of_flat_dt_get_machine_name());\n\n    return best_data;\n }\n')),(0,i.kt)("p",{parentName:"li"},"\u5148\u662f\u83b7\u53d6\u6839\u8282\u70b9\u540e\u5faa\u73af\u5339\u914dmachine_desc\uff0cof_flat_dt_match \u51fd\u6570\u4f1a\u5c06\u6839\u8282\u70b9 compatible \u5c5e\u6027\u7684\u503c\u548c\u6bcf\u4e2a machine_desc \u7ed3\u6784\u4f53\u4e2d. dt_compat \u7684\u503c\u8fdb\u884c\u6bd4\u8f83"))),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{parentName:"p",src:"https://pic.imgdb.cn/item/6502cdca661c6c8e54f35c8e",alt:"image-20230914170923494"}))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u5411\u8282\u70b9\u8ffd\u52a0\u6216\u8005\u4fee\u6539\u5185\u5bb9")),(0,i.kt)("p",{parentName:"li"},"imx6ull.dtsi \u6709\u539f\u59cb\u5185\u5bb9\uff0c\u4e00\u822c\u6765\u8bf4\u5982\u679c\u8981\u5bf96ull\u6240\u6709\u677f\u90fd\u52a0\u5185\u5bb9\u624d\u8981\u5728\u8fd9\u4e2a\u5934\u6587\u4ef6\u91cc\u52a0\u5165\u3002"),(0,i.kt)("p",{parentName:"li"},"\u5982\u679c\u8981\u8ffd\u52a0\uff0c\u5efa\u8bae\u5728\u81ea\u5df1\u7684dts\u4e2d\u52a0\u5165\uff0c\u6bd4\u5982imx6ull-alientek-emmc.dts"),(0,i.kt)("p",{parentName:"li"},"\u5982\u679c\u8981\u4fee\u6539i2c\uff0c\u52a0\u5165\u8282\u70b9\uff0c\u53ef\u4ee5\u8fd9\u6837"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"&i2c1{\n    \u8ffd\u52a0\u7684\u5185\u5bb9\n    \n}\n")),(0,i.kt)("p",{parentName:"li"},"\u5177\u4f53\u7684\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},'&i2c1\n{\n    clock - frequency = <100000>;\n    pinctrl - names = "default";\n    pinctrl - 0 = <&pinctrl_i2c1>;\n    status = "okay";\n\n    mag3110@0e\n    {\n        compatible = "fsl,mag3110";\n        reg = <0x0e>;\n        position = <2>;\n    };\n\n    fxls8471@1e\n    {\n        compatible = "fsl,fxls8471";\n        reg = <0x1e>;\n        position = <0>;\n        interrupt - parent = <&gpio5>;\n        interrupts = <0 8>;\n    };\n}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u6784\u5efa\u5c0f\u578b\u8bbe\u5907\u6811"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"/\u6839\u8282\u70b9"),(0,i.kt)("li",{parentName:"ol"},"\u677f\u5b50compatible\u5c5e\u6027"),(0,i.kt)("li",{parentName:"ol"},"CPU"),(0,i.kt)("li",{parentName:"ol"},"SOC",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"OCRAM"),(0,i.kt)("li",{parentName:"ol"},"3\u4e2aAIPS\u5916\u8bbe\u63a7\u5236\u5668\u8282\u70b9",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"\u5404\u7c7b\u5916\u8bbe\u5b50\u8282\u70b9"))))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8fdb\u5165/sys/firmware/devicetree\u770b\u8bbe\u5907\u6811\u4fe1\u606f")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u7279\u6b8a\u8282\u70b9"),"\uff1a")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"aliases"),"\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"/ {\n    aliases {\n        can0 = &flexcan1;\n        can1 = &flexcan2;\n        ethernet0 = &fec1;\n        ethernet1 = &fec2;\n        gpio0 = &gpio1;\n        gpio1 = &gpio2;\n        gpio2 = &gpio3;\n        gpio3 = &gpio4;\n        gpio4 = &gpio5;\n        i2c0 = &i2c1;\n        i2c1 = &i2c2;\n        i2c2 = &i2c3;\n        i2c3 = &i2c4;\n        mmc0 = &usdhc1;\n        mmc1 = &usdhc2;\n        serial0 = &uart1;\n        serial1 = &uart2;\n        serial2 = &uart3;\n        serial3 = &uart4;\n        serial4 = &uart5;\n        serial5 = &uart6;\n        serial6 = &uart7;\n        serial7 = &uart8;\n        spi0 = &ecspi1;\n        spi1 = &ecspi2;\n        spi2 = &ecspi3;\n        spi3 = &ecspi4;\n        usbphy0 = &usbphy1;\n        usbphy1 = &usbphy2;\n    };\n")),(0,i.kt)("p",{parentName:"li"},"\u5b9a\u4e49\u522b\u540d\uff0c\u901a\u8fc7label\u6548\u679c\u4e5f\u5dee\u4e0d\u591a")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"chosen"),"\uff1a\u4e3a\u4e86 uboot \u5411 Linux \u5185\u6838\u4f20\u9012\u6570\u636e\uff0c\u91cd\u70b9\u5728bootargs\u53c2\u6570"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"chosen {\n   stdout-path = &uart1;\n};\n")),(0,i.kt)("img",{src:"https://pic.imgdb.cn/item/6502fc1a661c6c8e540d4d52",alt:"image-20230914202705993"}),(0,i.kt)("p",{parentName:"li"},"\u770b\u5230\u6ca1\uff0c\u591a\u4e86bootargs"),(0,i.kt)("p",{parentName:"li"},"\u5728uboot\u6e90\u7801\u4e2d\u627e\u5230\u4e86\u5173\u4e8e\u8fd9\u4e2abootargs\u7684\u52a0\u8f7d"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},'int fdt_chosen(void *fdt)\n{\n    int   nodeoffset;\n    int   err;\n    char  *str;     /* used to set string properties */\n\n    err = fdt_check_header(fdt);\n    if (err < 0) {\n        printf("fdt_chosen: %s\\n", fdt_strerror(err));\n        return err;\n    }\n\n    /* find or create "/chosen" node. */\n    nodeoffset = fdt_find_or_add_subnode(fdt, 0, "chosen");\n    if (nodeoffset < 0)\n        return nodeoffset;\n\n    str = getenv("bootargs");\n    if (str) {\n        err = fdt_setprop(fdt, nodeoffset, "bootargs", str,\n                  strlen(str) + 1);\n        if (err < 0) {\n            printf("WARNING: could not set bootargs %s.\\n",\n                   fdt_strerror(err));\n            return err;\n        }\n    }\n\n    return fdt_fixup_stdout(fdt, nodeoffset);\n}\n')),(0,i.kt)("p",{parentName:"li"},"\u5148\u68c0\u67e5fdt\u5934\uff0c\u7136\u540e\u627e\u5230chosen\u8282\u70b9\uff0c\u5c06bootargs\u7684\u73af\u5883\u53d8\u91cf\u52a0\u5230fdt\u91cc"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{parentName:"p",src:"https://pic.imgdb.cn/item/6503015d661c6c8e540efe9b",alt:"image-20230914204933070"})))))),(0,i.kt)("h4",{id:"linux\u5185\u6838\u89e3\u6790dtb\u6587\u4ef6"},(0,i.kt)("strong",{parentName:"h4"},"Linux\u5185\u6838\u89e3\u6790DTB\u6587\u4ef6")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://pic.imgdb.cn/item/650304e0661c6c8e5410ee66",alt:"image-20230914210427155"})),(0,i.kt)("h4",{id:"\u7ed1\u5b9a\u4fe1\u606f\u6587\u6863"},"\u7ed1\u5b9a\u4fe1\u606f\u6587\u6863"),(0,i.kt)("p",null,"\u5728Documentation/devicetree/bindings\uff0c\u6709\u5f88\u591atxt\u7528\u6765\u8bf4\u660e\u8282\u70b9\u7684\u4fe1\u606f"),(0,i.kt)("h4",{id:"\u8bbe\u5907\u6811\u5e38\u7528--of-\u64cd\u4f5c\u51fd\u6570"},"\u8bbe\u5907\u6811\u5e38\u7528  OF \u64cd\u4f5c\u51fd\u6570"),(0,i.kt)("p",null,"Linux\u63d0\u4f9b\u4e00\u7cfb\u5217",(0,i.kt)("inlineCode",{parentName:"p"},"of_"),"\u524d\u7f00\u7684\u51fd\u6570\u7528\u4e8e\u83b7\u53d6\u8bbe\u5907\u6811\u8282\u70b9/\u5c5e\u6027\u4fe1\u606f"),(0,i.kt)("p",null,"\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"device_node"),"\u7ed3\u6784\u4f53\u63cf\u8ff0\u8282\u70b9\u4fe1\u606f"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_find_node_by_name"),"\u51fd\u6570"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct device_node *of_find_node_by_name(struct device_node  *from,const char *name)\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_find_compatible_node"),"\u51fd\u6570"),(0,i.kt)("p",{parentName:"li"},"\u6839\u636edevice_type\u548ccompatible\uff0cfrom\u4e3a\u5f00\u59cb\u67e5\u627e\u7684\u8282\u70b9\uff0c\u5982\u679cNULL\u5c31\u627e\u6574\u4e2a\u8bbe\u5907\u6811"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct device_node *of_find_compatible_node(struct device_node *from,\n                                        const char *type,\n                                        const char *compatible)\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_find_node_by_type")," \u51fd\u6570"),(0,i.kt)("p",{parentName:"li"},"\u6839\u636edevice_type \u5c5e\u6027\u67e5\u627e\u6307\u5b9a\u7684\u8282\u70b9"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct device_node *of_find_node_by_type(struct device_node *from, const char *type)\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_find_matching_node_and_match")," \u51fd\u6570"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct device_node *of_find_matching_node_and_match(struct device_node             *from,\nconst struct of_device_id  *matches, \nconst struct of_device_id **match)\n")),(0,i.kt)("p",{parentName:"li"},"\u6839\u636eof_device_id\u5339\u914d\u8868\u67e5\u627e\u6307\u5b9a\u8282\u70b9\uff08matches")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_find_node_by_path")," \u51fd\u6570"),(0,i.kt)("p",{parentName:"li"},"\u6839\u636epath\u6765\u627e\uff08such as /backlight"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u67e5\u627e\u7236/\u5b50\u8282\u70b9\u7684OF\u51fd\u6570")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"of_get_parent(device_node *node)"),(0,i.kt)("li",{parentName:"ol"},"of_get_next_child(device_node ",(0,i.kt)("em",{parentName:"li"},"node , device_node "),"prev)\uff08\u7236\u8282\u70b9\uff0c\u524d\u4e00\u4e2a\u5b50\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u4ece\u54ea\u4e00\u4e2a\u5b50\u8282\u70b9\u5f00\u59cb\u8fed\u4ee3\u7684\u67e5\u627e\u4e0b\u4e00\u4e2a\u5b50\u8282\u70b9\uff09")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u63d0\u53d6\u5c5e\u6027\u503c\u7684OF\u51fd\u6570"),"\u3001\u5b9a\u4e49\u5728\u6587\u4ef6  include/linux/of.h \u4e2d"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct property {\n    char    *name;\n    int length;\n    void    *value;\n    struct property *next;\n    unsigned long _flags;\n    unsigned int unique_id;\n    struct bin_attribute attr;\n};\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_find_property")," \u51fd\u6570\uff0c\u67e5\u627e\u7279\u5b9a\u7684\u5c5e\u6027"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct property *of_find_property(const struct device_node *np,\n                     const char *name,\n                     int *lenp);\n")),(0,i.kt)("p",{parentName:"li"},"np\uff1a\u8bbe\u5907\u8282\u70b9\uff0cname\uff1a\u5c5e\u6027\u540d\u5b57\uff0clenp\uff1a\u5c5e\u6027\u7684\u5b57\u8282\u6570")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"of_property_count_elems_of_size")," \u51fd\u6570\uff0c\u83b7\u53d6\u5c5e\u6027\u4e2d\u5143\u7d20\u7684\u6570\u91cf"),(0,i.kt)("p",{parentName:"li"},"\uff08\u8bbe\u5907\u8282\u70b9node\uff0c\u5c5e\u6027\u540d\uff0c\u5143\u7d20\u957f\u5ea6\uff08\u8fd9\u4e2a\u5c45\u7136\u4e0d\u662f\u6307\u9488\uff1f\uff1f\uff1f\uff09")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8fd8\u6709\u597d\u591a\u5efa\u8bae\u81ea\u5df1\u67e5"))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"of_address_to_resource \u51fd\u6570"),(0,i.kt)("p",{parentName:"li"},"\u5185\u6838\u4f7f\u7528 ",(0,i.kt)("strong",{parentName:"p"},"resource")," \u7ed3\u6784\u4f53\u6765\u63cf\u8ff0\u4e00\u6bb5\u5185\u5b58\u7a7a\u95f4"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-c"},"struct resource {\n    resource_size_t start;\n    resource_size_t end;\n    const char *name;\n    unsigned long flags;//\u8d44\u6e90\u6807\u5fd7\u4f4d\uff0c\u5177\u4f53\u5b8f\u5b9a\u4e49\u4e5f\u5728include/linux/ioport.h \n    struct resource *parent, *sibling, *child;\n};\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"of_iomap"))),(0,i.kt)("p",null,"\u7ed3\u675f\u529b"),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"\u8fd9\u4e9b\u51fd\u6570\u90fd\u662f\u8981\u88ab\u9a71\u52a8\u6587\u4ef6\u6240\u7528\u7684\uff0c\u8981\u8bfb\u53d6\u8bbe\u5907\u6811\u4e2d\u7684\u5c5e\u6027\u4fe1\u606f\uff0c\u6bd4\u5982\u5185\u5b58\u4fe1\u606f\u3001GPIO \u4fe1\u606f\u3001\u4e2d\u65ad\u4fe1\u606f\u7b49\u7b49")))}u.isMDXComponent=!0}}]);